

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Streaming data to disk &mdash; EPICS support for quad electrometers/picoammeters</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/my_theme.css?v=254ed751" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Performance" href="performance.html" />
    <link rel="prev" title="Using Feedback" href="feedback.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            quadEM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="databases.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="averaging.html">Averaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="tetramm_modes.html">TetrAMM Acquisition Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="tetramm_scanning.html">Scanning with the TetrAMM</a></li>
<li class="toctree-l1"><a class="reference internal" href="feedback.html">Using Feedback</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Streaming data to disk</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">quadEM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Streaming data to disk</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/streaming.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="streaming-data-to-disk">
<h1>Streaming data to disk<a class="headerlink" href="#streaming-data-to-disk" title="Link to this heading"></a></h1>
<p>The example IOCs in quadEM load the file ADCore/iocBoot/commonPlugins.cmd.
This provides all the standard file plugins, including HDF5, netCDF, and TIFF.
These can be used to stream the quadEM data to disk, with no limit on
the duration except for disk file size.</p>
<p>As explained in the Plugins section, the NDArray callbacks to plugins occur
each time NumAverage_RBV samples have been received from the device.
Callbacks on address 11 contain all the data items, and the NDArray
dimensions are [11, NumAverage_RBV] for each NDArray callback.</p>
<p>This is the medm screen for the HDF5 plugin used with the TetrAMM.
The TetrAMM is configured with ValuesPerRead=5, so it is sending data at 20 kHz.
AveragingTime is set to 0.1 seconds, so NumAverage_RBV is 2000.</p>
<figure class="align-center">
<img alt="_images/HDF5_stream.png" src="_images/HDF5_stream.png" />
</figure>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The Array address in the plugin is set to 11, so it is receiving all 11 data items.
FileWriteMode is set to Stream, so it will stream the NDArrays to the HDF5 file
as they arrive.  NumCapture is set to 200, so it will collect 200 arrays, each with
0.1 second of data giving a total of 20 seconds saved to disk.
Pressing the Start button starts the streaming.</p>
<p>The resulting file, quadEM_HDF5_001.h5, is 34 MB.</p>
<p>This is the result of the Linux h5dump –contents on that file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(base) [epics@corvette scratch]$ h5dump --contents quadEM_HDF5_001.h5
HDF5 &quot;quadEM_HDF5_001.h5&quot; {
FILE_CONTENTS {
 group      /
 group      /entry
 group      /entry/data
 dataset    /entry/data/data
 group      /entry/instrument
 group      /entry/instrument/NDAttributes
 dataset    /entry/instrument/NDAttributes/NDArrayEpicsTSSec
 dataset    /entry/instrument/NDAttributes/NDArrayEpicsTSnSec
 dataset    /entry/instrument/NDAttributes/NDArrayTimeStamp
 dataset    /entry/instrument/NDAttributes/NDArrayUniqueId
 group      /entry/instrument/detector
 group      /entry/instrument/detector/NDAttributes
 dataset    /entry/instrument/detector/data -&gt; /entry/data/data
 group      /entry/instrument/performance
 dataset    /entry/instrument/performance/timestamp
 }
}
</pre></div>
</div>
<p>The streamed data is in dataset /entry/data/data.
This is the output of h5dump –header, looking at just that dataset.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">DATASET</span> <span class="s2">&quot;data&quot;</span> <span class="p">{</span>
      <span class="n">DATATYPE</span>  <span class="n">H5T_IEEE_F64LE</span>
      <span class="n">DATASPACE</span>  <span class="n">SIMPLE</span> <span class="p">{</span> <span class="p">(</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">11</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">11</span> <span class="p">)</span> <span class="p">}</span>
      <span class="n">ATTRIBUTE</span> <span class="s2">&quot;NDArrayDimBinning&quot;</span> <span class="p">{</span>
         <span class="n">DATATYPE</span>  <span class="n">H5T_STD_I32LE</span>
         <span class="n">DATASPACE</span>  <span class="n">SIMPLE</span> <span class="p">{</span> <span class="p">(</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">ATTRIBUTE</span> <span class="s2">&quot;NDArrayDimOffset&quot;</span> <span class="p">{</span>
         <span class="n">DATATYPE</span>  <span class="n">H5T_STD_I32LE</span>
         <span class="n">DATASPACE</span>  <span class="n">SIMPLE</span> <span class="p">{</span> <span class="p">(</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">ATTRIBUTE</span> <span class="s2">&quot;NDArrayDimReverse&quot;</span> <span class="p">{</span>
         <span class="n">DATATYPE</span>  <span class="n">H5T_STD_I32LE</span>
         <span class="n">DATASPACE</span>  <span class="n">SIMPLE</span> <span class="p">{</span> <span class="p">(</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">ATTRIBUTE</span> <span class="s2">&quot;NDArrayNumDims&quot;</span> <span class="p">{</span>
         <span class="n">DATATYPE</span>  <span class="n">H5T_STD_I32LE</span>
         <span class="n">DATASPACE</span>  <span class="n">SCALAR</span>
      <span class="p">}</span>
      <span class="n">ATTRIBUTE</span> <span class="s2">&quot;signal&quot;</span> <span class="p">{</span>
         <span class="n">DATATYPE</span>  <span class="n">H5T_STD_I32LE</span>
         <span class="n">DATASPACE</span>  <span class="n">SCALAR</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It is IEEE 64-bit little-endian, with dimensions [200,2000,11].
In HDF5 convention the last array index is the fastest varying.</p>
<p>Saving all 11 data items is somewhat wastefull, since everything else can be calculated from just
the 4 currents, which are the first 4 items in the arrays.
We can save disk space by only saving the currents by using an ROI plugin between the
quadEM driver and the HDF5 plugin.</p>
<p>This is the medm screen for an ROI plugin which gets its data on address 11 from the TetrAMM port.
It is configured with a start of 0 and size of 4 on the first array dimension, and so will
select only the 4 currents.  The second dimension is set to auto size = Yes, so it will automatically
select all elements in the second dimension, even if NumAverage_RBV changes.</p>
<figure class="align-center">
<img alt="_images/ROI_stream.png" src="_images/ROI_stream.png" />
</figure>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The HDF5 plugin is changed to have its array port be ROI1, and the array address to be 0.
Note that the NDArrays being received are now [4, 2000].</p>
<figure class="align-center">
<img alt="_images/HDF5_stream_ROI.png" src="_images/HDF5_stream_ROI.png" />
</figure>
<p>The filename is changed to quadEM_HDF5_ROI_001.h5.  The resulting file size is 13 MB.</p>
<p>The following is an IDL program to process the data in quadEM_HDF5_001.h5.
The program does the following:</p>
<ul class="simple">
<li><p>Reads the dataset /entry/data/data into a variable called <cite>data</cite>.</p></li>
<li><p>Displays information about ‘data’.</p></li>
<li><p>Reformats ‘data’ from a 3-D array with dimensions [11, 2000, 200] to a 2-D array with dimensions [11, 400000].</p></li>
<li><p>Extracts the SumAll data into a variable called ‘sum_all’, which the 6’th column of ‘data’.</p></li>
<li><p>Compute a ‘time’ array variable which is the time of each sample.  It is 400000 points with 50 microseconds per point.</p></li>
<li><p>Plots the first 0.5 seconds (1000 points) of ‘sum_all’ vs ‘time’.</p></li>
<li><p>Computes the absolute value of the FFT of the ‘sum_all’ variable, which is the power spectrum.</p></li>
<li><p>Sets the first element (0 frequency, i.e. DC offset) to 0.</p></li>
<li><p>Computes the frequency acis, which is 200000 points going from 0 to the Nyquist freqency of 10 kHz.</p></li>
<li><p>Plots the power spectrum vs frequency.  Plots only the first 20000 points, which is 0 to 1 kHz, on a vertical log scale.</p></li>
</ul>
<p>This is the IDL code:</p>
<div class="highlight-idl notranslate"><div class="highlight"><pre><span></span><span class="c1">; Program to read HDF5 file for streamed quadEM data, plot it</span>
data<span class="w"> </span><span class="o">=</span><span class="w"> </span>h5_getdata(<span class="s1">&#39;J:\epics\scratch\quadEM_HDF5_001.h5&#39;</span>,<span class="w"> </span><span class="s1">&#39;/entry/data/data&#39;</span>)
<span class="nb">help</span>,<span class="w"> </span>data
<span class="c1">; Convert from a 3-D array [11, 2000, 200] to a 2-D array [11, 400000]</span>
data<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">reform</span>(data,<span class="w"> </span><span class="mi">11</span>,<span class="w"> </span><span class="mi">400000</span>)
<span class="c1">; Extract the SumAll data</span>
sum_all<span class="w"> </span><span class="o">=</span><span class="w"> </span>data[<span class="mi">6</span>,<span class="w"> </span><span class="o">*</span>]
<span class="c1">; Compute the time axis, 50 microseconds/sample</span>
time<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">findgen</span>(<span class="mi">400000</span>)<span class="w"> </span><span class="o">*</span><span class="w"> </span>50e<span class="o">-</span><span class="mi">6</span>
<span class="c1">; Plot the first 0.5 second of data</span>
p1<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">plot</span>(time[<span class="mi">0</span><span class="o">:</span><span class="mi">9999</span>],<span class="w"> </span>sum_all[<span class="mi">0</span><span class="o">:</span><span class="mi">9999</span>],<span class="w"> </span>xtitle<span class="o">=</span><span class="s1">&#39;Time (s)&#39;</span>,<span class="w"> </span>ytitle<span class="o">=</span><span class="s1">&#39;Sum of all diodes (nA)&#39;</span>,<span class="w"> </span>$
<span class="w">          </span>title<span class="o">=</span><span class="s1">&#39;Time Series&#39;</span>,<span class="w"> </span>color<span class="o">=</span><span class="s1">&#39;blue&#39;</span>)
p1.<span class="nb">save</span>,<span class="w"> </span><span class="s1">&#39;IDL_HDF5_time_plot.png&#39;</span>
<span class="c1">; Compute the FFT</span>
f<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">fft</span>(sum_all)
<span class="c1">; Take the absolute value, first half of array</span>
f_abs<span class="w"> </span><span class="o">=</span><span class="w"> </span>(<span class="nb">abs</span>(f))[<span class="mi">0</span><span class="o">:</span><span class="mi">199999</span>]
<span class="c1">; Set the DC offset to 0</span>
f_abs[<span class="mi">0</span>]<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="c1">; Compute the frequency axis. The sampling rate is 20 kHz so the Nyquist frequency is 10 kHz</span>
freq<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">findgen</span>(<span class="mi">200000</span>)<span class="o">/</span><span class="mi">199999</span>.<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10000</span>.
<span class="c1">; Plot the data out to 1 kHz</span>
p2<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">plot</span>(freq[<span class="mi">0</span><span class="o">:</span><span class="mi">19999</span>],<span class="w"> </span>f_abs[<span class="mi">0</span><span class="o">:</span><span class="mi">199999</span>],<span class="w"> </span>xtitle<span class="o">=</span><span class="s1">&#39;Frequency (Hz)&#39;</span>,<span class="w"> </span>ytitle<span class="o">=</span><span class="s1">&#39;SumAll Intensity&#39;</span>,<span class="w"> </span>$
<span class="w">          </span>title<span class="o">=</span><span class="s1">&#39;Power Spectrum&#39;</span>,<span class="w"> </span>color<span class="o">=</span><span class="s1">&#39;red&#39;</span>,<span class="w"> </span><span class="o">/</span>ylog,<span class="w"> </span>yrange<span class="o">=</span>[.<span class="mi">01</span>,<span class="mi">100</span>])
p2.<span class="nb">save</span>,<span class="w"> </span><span class="s1">&#39;IDL_HDF5_frequency_plot.png&#39;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>This is the output when the program is compiled and run:</p>
<div class="highlight-idl notranslate"><div class="highlight"><pre><span></span>IDL<span class="o">&gt;</span><span class="w"> </span>.compile<span class="w"> </span><span class="o">-</span>v<span class="w"> </span><span class="s1">&#39;C:\Scratch\plot_quadem.pro&#39;</span>
IDL<span class="o">&gt;</span><span class="w"> </span>.go
DATA<span class="w">            </span><span class="nb">DOUBLE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span>Array[<span class="mi">11</span>,<span class="w"> </span><span class="mi">2000</span>,<span class="w"> </span><span class="mi">200</span>]
</pre></div>
</div>
<p>This is the time-series plot.  The data are highly periodic because the photodiodes were illuminated
by fluorescent lights.</p>
<figure class="align-center">
<img alt="_images/IDL_HDF5_time_plot.png" src="_images/IDL_HDF5_time_plot.png" />
</figure>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>This is the frequency plot.  The frequency peaks are almost exclusively 60 Hz and its odd and even harmonics.
The odd harmonics are ~10-100 times less than 60Hz, and the even harmonics are ~100-1000 times less than 60 Hz.</p>
<figure class="align-center">
<img alt="_images/IDL_HDF5_frequency_plot.png" src="_images/IDL_HDF5_frequency_plot.png" />
</figure>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="feedback.html" class="btn btn-neutral float-left" title="Using Feedback" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="performance.html" class="btn btn-neutral float-right" title="Performance" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mark Rivers.
      <span class="lastupdated">Last updated on 2025-November-28.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>